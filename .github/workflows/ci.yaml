---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: ci

on:
  workflow_dispatch:
  push:
    branches: [ 'main' ]
    tags:
      - '*'
    paths-ignore:
      - '.github/**'
      - 'docs/**'
      - '**.md'
  pull_request:
    branches: [ 'main' ]
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.github/**'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - name: Setup Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Setup Workflow Tools
        run: brew install ktlint detekt

      - name: Install uv
        uses: astral-sh/setup-uv@e92bafb6253dcd438e0484186d7669ea7a8ca1cc # v6.4.3
        with:
          version: "0.5.30"

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
            python-version: '3.13'

      - name: Lint check
        run: ktlint --reporter=sarif,output=ktlint.sarif --editorconfig .editorconfig ./src/**/*.kt build.gradle.kts

      - name: Code analysis
        run: detekt --config detekt.yaml --input ./src,build.gradle.kts --report sarif:report.sarif

      - name: Upload SARIF to GitHub using the upload-sarif action
        uses: github/codeql-action/upload-sarif@76621b61decf072c1cee8dd1ce2d2a82d33c17ed # v3
        if: success() || failure()
        with:
          sarif_file: report.sarif

  prepare:
    name: Prepare
    needs: ["lint"]
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.bake-images.outputs.images }}
      version: ${{ steps.image-version.outputs.semantic }}
      valid-release: ${{ steps.image-version.outputs.valid-release == 'true' }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          persist-credentials: false

      - name: Get Bake Images
        id: bake-images
        uses: ./.github/actions/bake-images

      - name: Set input version
        id: input-version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Get semantic version
        uses: ./.github/actions/image-versions
        id: image-version
        with:
          input-version: ${{ steps.input-version.outputs.VERSION }}

  build:
    name: Build
    needs: ["prepare"]
    uses: ./.github/workflows/image-builder.yaml
    permissions:
      attestations: write
      contents: write
      id-token: write
      packages: write
      security-events: write
    secrets: inherit
    strategy:
      matrix:
        image: ${{ fromJSON(needs.prepare.outputs.images) }}
      fail-fast: false
      max-parallel: 4
    with:
      image: ${{ matrix.image }}
      version: ${{ needs.prepare.outputs.version }}
      release: ${{ needs.prepare.outputs.valid-release && github.event_name != 'pull_request' }}

  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: ["build"]
    if: ${{ needs.prepare.outputs.valid-release && github.event_name != 'pull_request' }}
    permissions:
      contents: write
    outputs:
      digest: ${{ steps.digest.outputs.digest }}
    steps:
      - name: Generate Token
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

      - name: Create Release
        shell: bash
        continue-on-error: true
        env:
          GITHUB_TOKEN: "${{ steps.app-token.outputs.token }}"
        run: |
          gh release create "${{ needs.prepare.outputs.original-tag }}" \
              --repo="${GITHUB_REPOSITORY}" \
              --title="${{ needs.prepare.outputs.original-tag }}" \
              --generate-notes
